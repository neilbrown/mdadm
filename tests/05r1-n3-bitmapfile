
#
# create a raid1 with 3 devices and a bitmap file
# make  sure resync does right thing.
#
#
bmf=$targetdir/bitmap
rm -f $bmf
mdadm --create -e0.90 --run $md0 --level=1 -n3 --delay=1  --bitmap $bmf $dev1 $dev2 $dev3
check wait
testdev $md0 1 $mdsize0 64
mdadm -S $md0

mdadm --assemble $md0 --bitmap=$bmf $dev1 $dev2 $dev3
testdev $md0 1 $mdsize0 64
dirty1=`mdadm -X $bmf | sed -n -e 's/.*Bitmap.* \([0-9]*\) dirty.*/\1/p'`
sleep 4
dirty2=`mdadm -X $bmf | sed -n -e 's/.*Bitmap.* \([0-9]*\) dirty.*/\1/p'`

if [ $dirty1 -lt 400 -o $dirty2 -ne 0 ]
then  echo >&2 "ERROR bad 'dirty' counts: $dirty1 and $dirty2"
  exit 1
fi
mdadm $md0 -f $dev2
testdev $md0 1 $mdsize0 64
sleep 4
dirty3=`mdadm -X $bmf | sed -n -e 's/.*Bitmap.* \([0-9]*\) dirty.*/\1/p'`
if [ $dirty3 -lt 400 ]
then
   echo >&2 "ERROR dirty count $dirty3 is too small"
   exit 2
fi

mdadm -S $md0

mdadm --assemble -R $md0 --bitmap=$bmf $dev1 $dev3
check nosync
mdadm --zero-superblock $dev2
mdadm $md0 --add $dev2
check recovery

dirty4=`mdadm -X $bmf | sed -n -e 's/.*Bitmap.* \([0-9]*\) dirty.*/\1/p'`
check wait
sleep 4
dirty5=`mdadm -X $bmf | sed -n -e 's/.*Bitmap.* \([0-9]*\) dirty.*/\1/p'`

if [ $dirty4 -lt 400 -o $dirty5 -ne 0 ]
then echo echo >&2 "ERROR bad 'dirty' counts at end: $dirty4 $dirty5"
  exit 1
fi

mdadm -S $md0
exit 0
